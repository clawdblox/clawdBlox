#!/bin/sh
# MemoryWeave CLI wrapper for OpenClaw
# Usage: mw <command> [args...]

MW_VERSION="0.1.0"
EXIT_OK=0
EXIT_USAGE=1
EXIT_NETWORK=2
EXIT_API=3

BASE_URL="${MEMORYWEAVE_BASE_URL:-http://localhost:3000}"
API_KEY="${MEMORYWEAVE_API_KEY}"

if [ -z "$API_KEY" ]; then
  printf "${RED}Error: MEMORYWEAVE_API_KEY is not set${RESET}\n" >&2
  exit $EXIT_USAGE
fi

if [ -t 1 ] && [ "${MW_NO_COLOR:-0}" != "1" ]; then
  RED='\033[0;31m'
  GREEN='\033[0;32m'
  BOLD='\033[1m'
  RESET='\033[0m'
else
  RED=''
  GREEN=''
  BOLD=''
  RESET=''
fi

debug() {
  [ "${MW_DEBUG:-0}" = "1" ] && echo "[DEBUG] $*" >&2
}

format_json() {
  if [ "${MW_RAW:-0}" != "1" ] && command -v jq >/dev/null 2>&1; then
    jq .
  else
    cat
  fi
}

is_retryable() {
  case "$1" in
    6|7|28|56) return 0 ;;
    *) return 1 ;;
  esac
}

request() {
  method="$1"
  path="$2"
  body="$3"
  max_attempts=3
  attempt=1
  delay=1

  debug "$method ${BASE_URL}/api/v1${path}"
  [ -n "$body" ] && debug "Body: $body"

  if [ -n "$body" ] && command -v jq >/dev/null 2>&1; then
    if ! printf '%s' "$body" | jq . >/dev/null 2>&1; then
      printf "${RED}Error: invalid JSON body${RESET}\n" >&2
      return $EXIT_USAGE
    fi
  fi

  tmpfile=$(mktemp)
  trap 'rm -f "$tmpfile"' EXIT

  while [ $attempt -le $max_attempts ]; do
    if [ -n "$body" ]; then
      http_code=$(curl -s -X "$method" \
        --max-time "${MW_TIMEOUT:-30}" --connect-timeout 10 \
        -H "x-api-key: $API_KEY" \
        -H "Content-Type: application/json" \
        -d "$body" \
        -o "$tmpfile" -w '%{http_code}' \
        "${BASE_URL}/api/v1${path}" 2>&1)
    else
      http_code=$(curl -s -X "$method" \
        --max-time "${MW_TIMEOUT:-30}" --connect-timeout 10 \
        -H "x-api-key: $API_KEY" \
        -o "$tmpfile" -w '%{http_code}' \
        "${BASE_URL}/api/v1${path}" 2>&1)
    fi
    status=$?

    if [ $status -ne 0 ]; then
      debug "Curl exit code: $status"
      if ! is_retryable $status || [ $attempt -eq $max_attempts ]; then
        printf "${RED}Error: request failed (exit code $status)${RESET}\n" >&2
        rm -f "$tmpfile"
        return $EXIT_NETWORK
      fi
      echo "Retrying in ${delay}s (attempt $attempt/$max_attempts)..." >&2
      sleep $delay
      delay=$((delay * 2))
      attempt=$((attempt + 1))
      continue
    fi

    debug "HTTP $http_code"

    if [ "$http_code" -ge 400 ] 2>/dev/null; then
      err_msg=$(cat "$tmpfile")
      if command -v jq >/dev/null 2>&1; then
        parsed=$(printf '%s' "$err_msg" | jq -r '.error // .message // empty' 2>/dev/null)
        [ -n "$parsed" ] && err_msg="$parsed"
      fi
      printf "${RED}Error: HTTP $http_code — $err_msg${RESET}\n" >&2
      rm -f "$tmpfile"
      return $EXIT_API
    fi

    debug "Response (status: ok)"
    cat "$tmpfile" | format_json
    rm -f "$tmpfile"
    return $EXIT_OK
  done
}

case "$1" in
  --version|-v)
    echo "mw $MW_VERSION"
    exit $EXIT_OK
    ;;

  --help|-h)
    printf "${BOLD}mw $MW_VERSION — MemoryWeave CLI${RESET}\n"
    echo ""
    echo "Usage: mw <command> [args...]"
    echo ""
    echo "NPCs:"
    echo "  list-npcs [page] [limit]                List all NPCs (paginated)"
    echo "  get-npc <id>                             Get NPC details"
    echo "  create-npc '<json>'                      Create a new NPC"
    echo "  generate-npc '<json>'                    Generate an NPC with AI"
    echo "  update-npc <id> '<json>'                 Update an NPC"
    echo "  delete-npc <id>                          Delete an NPC"
    echo ""
    echo "Conversations:"
    echo "  list-conversations <npc_id> [page] [limit]  List NPC conversations"
    echo "  get-messages <conv_id> [limit]               Get conversation messages"
    echo "  chat-bot <npc_id> <platform> <user_id> <msg> Send a bot message"
    echo ""
    echo "Memories:"
    echo "  list-memories <npc_id> [page] [limit]   List NPC memories"
    echo "  search-memories <npc_id> '<json>'        Search memories semantically"
    echo "  create-memory <npc_id> '<json>'          Create a memory"
    echo ""
    echo "Life System:"
    echo "  list-routines <npc_id>                   List NPC routines"
    echo "  create-routine <npc_id> '<json>'         Create a routine"
    echo "  list-goals <npc_id>                      List NPC goals"
    echo "  create-goal <npc_id> '<json>'            Create a goal"
    echo "  list-relationships <npc_id>              List NPC relationships"
    echo "  create-relationship <npc_id> '<json>'    Create a relationship"
    echo ""
    echo "Channel Bindings:"
    echo "  bind-channel <npc_id> <platform> <ch_id> Bind NPC to a channel"
    echo "  unbind-channel <platform> <ch_id>        Unbind a channel"
    echo "  list-bindings                            List all channel bindings"
    echo "  resolve-channel <platform> <ch_id>       Resolve channel to NPC"
    echo ""
    echo "Project:"
    echo "  stats                                    Get project statistics"
    echo "  health                                   Check API health"
    echo ""
    echo "Environment variables:"
    echo "  MEMORYWEAVE_API_KEY    API key (required)"
    echo "  MEMORYWEAVE_BASE_URL  API base URL (default: http://localhost:3000)"
    echo "  MW_TIMEOUT            Request timeout in seconds (default: 30)"
    echo "  MW_DEBUG=1            Enable verbose output"
    echo "  MW_RAW=1              Disable JSON pretty-printing"
    exit $EXIT_OK
    ;;

  # === NPCs ===
  list-npcs)
    page="${2:-1}"
    limit="${3:-20}"
    request GET "/npcs?page=${page}&limit=${limit}"
    ;;
  get-npc)
    [ -z "$2" ] && echo "Usage: mw get-npc <npc_id>" >&2 && exit $EXIT_USAGE
    request GET "/npcs/$2"
    ;;
  create-npc)
    [ -z "$2" ] && echo "Usage: mw create-npc '<json_body>'" >&2 && exit $EXIT_USAGE
    request POST "/npcs" "$2"
    ;;
  generate-npc)
    [ -z "$2" ] && echo "Usage: mw generate-npc '<json_body>'" >&2 && exit $EXIT_USAGE
    request POST "/npcs/generate" "$2"
    ;;
  update-npc)
    [ -z "$2" ] || [ -z "$3" ] && echo "Usage: mw update-npc <npc_id> '<json_body>'" >&2 && exit $EXIT_USAGE
    request PUT "/npcs/$2" "$3"
    ;;
  delete-npc)
    [ -z "$2" ] && echo "Usage: mw delete-npc <npc_id>" >&2 && exit $EXIT_USAGE
    request DELETE "/npcs/$2"
    ;;

  # === Conversations ===
  list-conversations)
    [ -z "$2" ] && echo "Usage: mw list-conversations <npc_id> [page] [limit]" >&2 && exit $EXIT_USAGE
    page="${3:-1}"
    limit="${4:-20}"
    request GET "/npcs/$2/conversations?page=${page}&limit=${limit}"
    ;;
  get-messages)
    [ -z "$2" ] && echo "Usage: mw get-messages <conversation_id> [limit]" >&2 && exit $EXIT_USAGE
    limit="${3:-50}"
    request GET "/conversations/$2/messages?limit=${limit}"
    ;;
  chat-bot)
    [ -z "$2" ] || [ -z "$3" ] || [ -z "$4" ] || [ -z "$5" ] && \
      echo "Usage: mw chat-bot <npc_id> <platform> <platform_user_id> <message>" >&2 && exit $EXIT_USAGE
    escaped_msg=$(printf '%s' "$5" | sed -e 's/\\/\\\\/g' -e 's/"/\\"/g' -e 's/	/\\t/g' | tr '\n' ' ' | sed 's/\r//g')
    request POST "/npcs/$2/chat/bot" "{\"platform\":\"$3\",\"platform_user_id\":\"$4\",\"message\":\"$escaped_msg\"}"
    ;;

  # === Memories ===
  list-memories)
    [ -z "$2" ] && echo "Usage: mw list-memories <npc_id> [page] [limit]" >&2 && exit $EXIT_USAGE
    page="${3:-1}"
    limit="${4:-20}"
    request GET "/npcs/$2/memories?page=${page}&limit=${limit}"
    ;;
  search-memories)
    [ -z "$2" ] || [ -z "$3" ] && echo "Usage: mw search-memories <npc_id> '<json_body>'" >&2 && exit $EXIT_USAGE
    request POST "/npcs/$2/memories/search" "$3"
    ;;
  create-memory)
    [ -z "$2" ] || [ -z "$3" ] && echo "Usage: mw create-memory <npc_id> '<json_body>'" >&2 && exit $EXIT_USAGE
    request POST "/npcs/$2/memories" "$3"
    ;;
  get-memory)
    [ -z "$2" ] || [ -z "$3" ] && echo "Usage: mw get-memory <npc_id> <memory_id>" >&2 && exit $EXIT_USAGE
    request GET "/npcs/$2/memories/$3"
    ;;
  delete-memory)
    [ -z "$2" ] || [ -z "$3" ] && echo "Usage: mw delete-memory <npc_id> <memory_id>" >&2 && exit $EXIT_USAGE
    request DELETE "/npcs/$2/memories/$3"
    ;;

  # === Life (Routines, Goals, Relationships) ===
  list-routines)
    [ -z "$2" ] && echo "Usage: mw list-routines <npc_id>" >&2 && exit $EXIT_USAGE
    request GET "/npcs/$2/routines"
    ;;
  create-routine)
    [ -z "$2" ] || [ -z "$3" ] && echo "Usage: mw create-routine <npc_id> '<json_body>'" >&2 && exit $EXIT_USAGE
    request POST "/npcs/$2/routines" "$3"
    ;;
  list-goals)
    [ -z "$2" ] && echo "Usage: mw list-goals <npc_id>" >&2 && exit $EXIT_USAGE
    request GET "/npcs/$2/goals"
    ;;
  create-goal)
    [ -z "$2" ] || [ -z "$3" ] && echo "Usage: mw create-goal <npc_id> '<json_body>'" >&2 && exit $EXIT_USAGE
    request POST "/npcs/$2/goals" "$3"
    ;;
  list-relationships)
    [ -z "$2" ] && echo "Usage: mw list-relationships <npc_id>" >&2 && exit $EXIT_USAGE
    request GET "/npcs/$2/relationships"
    ;;
  create-relationship)
    [ -z "$2" ] || [ -z "$3" ] && echo "Usage: mw create-relationship <npc_id> '<json_body>'" >&2 && exit $EXIT_USAGE
    request POST "/npcs/$2/relationships" "$3"
    ;;

  # === Channel Bindings ===
  bind-channel)
    [ -z "$2" ] || [ -z "$3" ] || [ -z "$4" ] && echo "Usage: mw bind-channel <npc_id> <platform> <channel_id>" >&2 && exit $EXIT_USAGE
    request POST "/channels/bind" "{\"npc_id\":\"$2\",\"platform\":\"$3\",\"platform_channel_id\":\"$4\"}"
    ;;
  unbind-channel)
    [ -z "$2" ] || [ -z "$3" ] && echo "Usage: mw unbind-channel <platform> <channel_id>" >&2 && exit $EXIT_USAGE
    request DELETE "/channels/bind" "{\"platform\":\"$2\",\"platform_channel_id\":\"$3\"}"
    ;;
  list-bindings)
    request GET "/channels/bindings"
    ;;
  resolve-channel)
    [ -z "$2" ] || [ -z "$3" ] && echo "Usage: mw resolve-channel <platform> <channel_id>" >&2 && exit $EXIT_USAGE
    request GET "/channels/resolve?platform=$2&platform_channel_id=$3"
    ;;

  # === Stats ===
  stats)
    request GET "/stats"
    ;;

  # === Health ===
  health)
    curl -sf "${BASE_URL}/health"
    ;;

  *)
    printf "${RED}Unknown command: $1. Run 'mw --help' for usage.${RESET}\n" >&2
    exit $EXIT_USAGE
    ;;
esac
