#!/bin/sh
# MemoryWeave CLI wrapper for OpenClaw
# Usage: mw <command> [args...]

MW_VERSION="0.1.0"
EXIT_OK=0
EXIT_USAGE=1
EXIT_NETWORK=2
EXIT_API=3

# Color setup (must be defined before any output)
if [ -t 1 ] && [ "${MW_NO_COLOR:-0}" != "1" ]; then
  RED='\033[0;31m'
  GREEN='\033[0;32m'
  BOLD='\033[1m'
  RESET='\033[0m'
else
  RED=''
  GREEN=''
  BOLD=''
  RESET=''
fi

BASE_URL="${MEMORYWEAVE_BASE_URL:-http://localhost:3000}"
API_KEY="${MEMORYWEAVE_API_KEY}"

if [ -z "$API_KEY" ]; then
  printf "${RED}Error: MEMORYWEAVE_API_KEY is not set${RESET}\n" >&2
  exit $EXIT_USAGE
fi

tmpfile=$(mktemp)
trap 'rm -f "$tmpfile"' EXIT

debug() {
  [ "${MW_DEBUG:-0}" = "1" ] && echo "[DEBUG] $*" >&2
}

format_json() {
  if [ "${MW_RAW:-0}" != "1" ] && command -v jq >/dev/null 2>&1; then
    jq .
  else
    cat
  fi
}

json_escape_string() {
  if command -v jq >/dev/null 2>&1; then
    printf '%s' "$1" | jq -Rs '.' | sed 's/^"//;s/"$//'
  else
    printf '%s' "$1" | sed -e 's/\\/\\\\/g' \
      -e 's/"/\\"/g' \
      -e 's/	/\\t/g' \
      -e 's/\x08/\\b/g' \
      -e 's/\x0c/\\f/g' \
      -e 's/\r/\\r/g' | awk '{
      if (NR > 1) printf "\\n"
      printf "%s", $0
    }'
  fi
}

urlencode() {
  printf '%s' "$1" | awk '
    BEGIN {
      for (i = 0; i < 256; i++) ord[sprintf("%c", i)] = i
    }
    {
      n = split($0, chars, "")
      for (i = 1; i <= n; i++) {
        c = chars[i]
        if (c ~ /[A-Za-z0-9._~-]/)
          printf "%s", c
        else
          printf "%%%02X", ord[c]
      }
    }'
}

is_retryable() {
  case "$1" in
    6|7|28|56) return 0 ;;
    *) return 1 ;;
  esac
}

request() {
  method="$1"
  path="$2"
  body="$3"
  raw="${4:-}"
  max_attempts=3
  attempt=1
  delay=1

  if [ "$raw" = "raw" ]; then
    url="${BASE_URL}${path}"
  else
    url="${BASE_URL}/api/v1${path}"
  fi

  debug "$method $url"
  [ -n "$body" ] && debug "Body: $body"

  if [ -n "$body" ] && command -v jq >/dev/null 2>&1; then
    if ! printf '%s' "$body" | jq . >/dev/null 2>&1; then
      printf "${RED}Error: invalid JSON body${RESET}\n" >&2
      return $EXIT_USAGE
    fi
  fi

  while [ "$attempt" -le "$max_attempts" ]; do
    http_code=$(curl -s -X "$method" \
      --max-time "${MW_TIMEOUT:-30}" --connect-timeout 10 \
      -H "x-api-key: $API_KEY" \
      ${body:+-H "Content-Type: application/json" -d "$body"} \
      -o "$tmpfile" -w '%{http_code}' \
      "$url" 2>&1)
    status=$?

    if [ "$status" -ne 0 ]; then
      debug "Curl exit code: $status"
      if ! is_retryable "$status" || [ "$attempt" -eq "$max_attempts" ]; then
        printf "${RED}Error: request failed (exit code $status)${RESET}\n" >&2
        return $EXIT_NETWORK
      fi
      echo "Retrying in ${delay}s (attempt $attempt/$max_attempts)..." >&2
      sleep $delay
      delay=$((delay * 2))
      attempt=$((attempt + 1))
      continue
    fi

    debug "HTTP $http_code"

    case "$http_code" in
      [0-9][0-9][0-9]) ;;
      *) printf "${RED}Error: unexpected response${RESET}\n" >&2; return $EXIT_NETWORK ;;
    esac

    if [ "$http_code" -ge 400 ]; then
      err_msg=$(cat "$tmpfile")
      if command -v jq >/dev/null 2>&1; then
        parsed=$(printf '%s' "$err_msg" | jq -r '.error // .message // empty' 2>/dev/null)
        [ -n "$parsed" ] && err_msg="$parsed"
      fi
      printf "${RED}Error: HTTP $http_code — $err_msg${RESET}\n" >&2
      return $EXIT_API
    fi

    debug "Response (status: ok)"
    format_json < "$tmpfile"
    return $EXIT_OK
  done
}

# Require a non-empty argument; print usage and exit if missing
require_arg() {
  if [ -z "$1" ]; then
    echo "Usage: $2" >&2
    exit $EXIT_USAGE
  fi
}

case "$1" in
  --version|-v)
    echo "mw $MW_VERSION"
    exit $EXIT_OK
    ;;

  --help|-h)
    printf "${BOLD}mw $MW_VERSION — MemoryWeave CLI${RESET}\n"
    echo ""
    echo "Usage: mw <command> [args...]"
    echo ""
    echo "NPCs:"
    echo "  list-npcs [page] [limit] [sort_by] [sort_order]"
    echo "                                           List all NPCs (paginated, sortable)"
    echo "  get-npc <id>                             Get NPC details"
    echo "  create-npc '<json>'                      Create a new NPC"
    echo "  generate-npc '<json>'                    Generate an NPC with AI"
    echo "  update-npc <id> '<json>'                 Update an NPC"
    echo "  delete-npc <id>                          Delete an NPC"
    echo ""
    echo "Conversations:"
    echo "  list-conversations <npc_id> [page] [limit]   List NPC conversations"
    echo "  get-messages <conv_id> [limit]                Get conversation messages"
    echo "  export-conversation <conv_id>                 Export full conversation (up to 1000 msgs)"
    echo "  chat-bot <npc_id> <platform> <user_id> <msg>  Send a bot message"
    echo ""
    echo "Memories:"
    echo "  list-memories <npc_id> [page] [limit]    List NPC memories"
    echo "  get-memory <npc_id> <memory_id>          Get a specific memory"
    echo "  search-memories <npc_id> '<json>'         Search memories semantically"
    echo "  create-memory <npc_id> '<json>'           Create a memory"
    echo "  update-memory <npc_id> <memory_id> '<json>' Update a memory"
    echo "  delete-memory <npc_id> <memory_id>       Delete a memory"
    echo ""
    echo "Life System:"
    echo "  list-routines <npc_id>                   List NPC routines"
    echo "  get-routine <npc_id> <routine_id>        Get a specific routine"
    echo "  create-routine <npc_id> '<json>'         Create a routine"
    echo "  update-routine <npc_id> <routine_id> '<json>' Update a routine"
    echo "  delete-routine <npc_id> <routine_id>     Delete a routine"
    echo "  list-goals <npc_id>                      List NPC goals"
    echo "  get-goal <npc_id> <goal_id>              Get a specific goal"
    echo "  create-goal <npc_id> '<json>'            Create a goal"
    echo "  update-goal <npc_id> <goal_id> '<json>'  Update a goal"
    echo "  delete-goal <npc_id> <goal_id>           Delete a goal"
    echo "  list-relationships <npc_id>              List NPC relationships"
    echo "  get-relationship <npc_id> <rel_id>       Get a specific relationship"
    echo "  create-relationship <npc_id> '<json>'    Create a relationship"
    echo "  update-relationship <npc_id> <rel_id> '<json>' Update a relationship"
    echo "  delete-relationship <npc_id> <rel_id>    Delete a relationship"
    echo ""
    echo "Channel Bindings:"
    echo "  bind-channel <npc_id> <platform> <ch_id> Bind NPC to a channel"
    echo "  unbind-channel <platform> <ch_id>        Unbind a channel"
    echo "  list-bindings                            List all channel bindings"
    echo "  resolve-channel <platform> <ch_id>       Resolve channel to NPC"
    echo ""
    echo "Project:"
    echo "  stats                                    Get project statistics"
    echo "  health                                   Check API health"
    echo ""
    echo "Environment variables:"
    echo "  MEMORYWEAVE_API_KEY    API key (required)"
    echo "  MEMORYWEAVE_BASE_URL  API base URL (default: http://localhost:3000)"
    echo "  MW_TIMEOUT            Request timeout in seconds (default: 30)"
    echo "  MW_DEBUG=1            Enable verbose output"
    echo "  MW_RAW=1              Disable JSON pretty-printing"
    echo "  MW_NO_COLOR=1         Disable colored output"
    exit $EXIT_OK
    ;;

  # === NPCs ===
  list-npcs)
    page=$(urlencode "${2:-1}")
    limit=$(urlencode "${3:-20}")
    sort_by=$(urlencode "${4:-created_at}")
    sort_order=$(urlencode "${5:-desc}")
    request GET "/npcs?page=${page}&limit=${limit}&sort_by=${sort_by}&sort_order=${sort_order}"
    ;;
  get-npc)
    require_arg "$2" "mw get-npc <npc_id>"
    request GET "/npcs/$2"
    ;;
  create-npc)
    require_arg "$2" "mw create-npc '<json_body>'"
    request POST "/npcs" "$2"
    ;;
  generate-npc)
    require_arg "$2" "mw generate-npc '<json_body>'"
    request POST "/npcs/generate" "$2"
    ;;
  update-npc)
    require_arg "$2" "mw update-npc <npc_id> '<json_body>'"
    require_arg "$3" "mw update-npc <npc_id> '<json_body>'"
    request PUT "/npcs/$2" "$3"
    ;;
  delete-npc)
    require_arg "$2" "mw delete-npc <npc_id>"
    request DELETE "/npcs/$2"
    ;;

  # === Conversations ===
  list-conversations)
    require_arg "$2" "mw list-conversations <npc_id> [page] [limit]"
    page=$(urlencode "${3:-1}")
    limit=$(urlencode "${4:-20}")
    request GET "/npcs/$2/conversations?page=${page}&limit=${limit}"
    ;;
  get-messages)
    require_arg "$2" "mw get-messages <conversation_id> [limit]"
    limit=$(urlencode "${3:-50}")
    request GET "/conversations/$2/messages?limit=${limit}"
    ;;
  export-conversation)
    require_arg "$2" "mw export-conversation <conversation_id>"
    request GET "/conversations/$2/messages?limit=1000"
    ;;
  chat-bot)
    require_arg "$2" "mw chat-bot <npc_id> <platform> <platform_user_id> <message>"
    require_arg "$3" "mw chat-bot <npc_id> <platform> <platform_user_id> <message>"
    require_arg "$4" "mw chat-bot <npc_id> <platform> <platform_user_id> <message>"
    require_arg "$5" "mw chat-bot <npc_id> <platform> <platform_user_id> <message>"
    escaped_msg=$(json_escape_string "$5")
    request POST "/npcs/$2/chat/bot" "{\"platform\":\"$3\",\"platform_user_id\":\"$4\",\"message\":\"$escaped_msg\"}"
    ;;

  # === Memories ===
  list-memories)
    require_arg "$2" "mw list-memories <npc_id> [page] [limit]"
    page=$(urlencode "${3:-1}")
    limit=$(urlencode "${4:-20}")
    request GET "/npcs/$2/memories?page=${page}&limit=${limit}"
    ;;
  search-memories)
    require_arg "$2" "mw search-memories <npc_id> '<json_body>'"
    require_arg "$3" "mw search-memories <npc_id> '<json_body>'"
    request POST "/npcs/$2/memories/search" "$3"
    ;;
  create-memory)
    require_arg "$2" "mw create-memory <npc_id> '<json_body>'"
    require_arg "$3" "mw create-memory <npc_id> '<json_body>'"
    request POST "/npcs/$2/memories" "$3"
    ;;
  get-memory)
    require_arg "$2" "mw get-memory <npc_id> <memory_id>"
    require_arg "$3" "mw get-memory <npc_id> <memory_id>"
    request GET "/npcs/$2/memories/$3"
    ;;
  update-memory)
    require_arg "$2" "mw update-memory <npc_id> <memory_id> '<json_body>'"
    require_arg "$3" "mw update-memory <npc_id> <memory_id> '<json_body>'"
    require_arg "$4" "mw update-memory <npc_id> <memory_id> '<json_body>'"
    request PUT "/npcs/$2/memories/$3" "$4"
    ;;
  delete-memory)
    require_arg "$2" "mw delete-memory <npc_id> <memory_id>"
    require_arg "$3" "mw delete-memory <npc_id> <memory_id>"
    request DELETE "/npcs/$2/memories/$3"
    ;;

  # === Life (Routines, Goals, Relationships) ===
  list-routines)
    require_arg "$2" "mw list-routines <npc_id>"
    request GET "/npcs/$2/routines"
    ;;
  create-routine)
    require_arg "$2" "mw create-routine <npc_id> '<json_body>'"
    require_arg "$3" "mw create-routine <npc_id> '<json_body>'"
    request POST "/npcs/$2/routines" "$3"
    ;;
  get-routine)
    require_arg "$2" "mw get-routine <npc_id> <routine_id>"
    require_arg "$3" "mw get-routine <npc_id> <routine_id>"
    request GET "/npcs/$2/routines/$3"
    ;;
  update-routine)
    require_arg "$2" "mw update-routine <npc_id> <routine_id> '<json_body>'"
    require_arg "$3" "mw update-routine <npc_id> <routine_id> '<json_body>'"
    require_arg "$4" "mw update-routine <npc_id> <routine_id> '<json_body>'"
    request PUT "/npcs/$2/routines/$3" "$4"
    ;;
  delete-routine)
    require_arg "$2" "mw delete-routine <npc_id> <routine_id>"
    require_arg "$3" "mw delete-routine <npc_id> <routine_id>"
    request DELETE "/npcs/$2/routines/$3"
    ;;
  list-goals)
    require_arg "$2" "mw list-goals <npc_id>"
    request GET "/npcs/$2/goals"
    ;;
  create-goal)
    require_arg "$2" "mw create-goal <npc_id> '<json_body>'"
    require_arg "$3" "mw create-goal <npc_id> '<json_body>'"
    request POST "/npcs/$2/goals" "$3"
    ;;
  get-goal)
    require_arg "$2" "mw get-goal <npc_id> <goal_id>"
    require_arg "$3" "mw get-goal <npc_id> <goal_id>"
    request GET "/npcs/$2/goals/$3"
    ;;
  update-goal)
    require_arg "$2" "mw update-goal <npc_id> <goal_id> '<json_body>'"
    require_arg "$3" "mw update-goal <npc_id> <goal_id> '<json_body>'"
    require_arg "$4" "mw update-goal <npc_id> <goal_id> '<json_body>'"
    request PUT "/npcs/$2/goals/$3" "$4"
    ;;
  delete-goal)
    require_arg "$2" "mw delete-goal <npc_id> <goal_id>"
    require_arg "$3" "mw delete-goal <npc_id> <goal_id>"
    request DELETE "/npcs/$2/goals/$3"
    ;;
  list-relationships)
    require_arg "$2" "mw list-relationships <npc_id>"
    request GET "/npcs/$2/relationships"
    ;;
  create-relationship)
    require_arg "$2" "mw create-relationship <npc_id> '<json_body>'"
    require_arg "$3" "mw create-relationship <npc_id> '<json_body>'"
    request POST "/npcs/$2/relationships" "$3"
    ;;
  get-relationship)
    require_arg "$2" "mw get-relationship <npc_id> <relationship_id>"
    require_arg "$3" "mw get-relationship <npc_id> <relationship_id>"
    request GET "/npcs/$2/relationships/$3"
    ;;
  update-relationship)
    require_arg "$2" "mw update-relationship <npc_id> <relationship_id> '<json_body>'"
    require_arg "$3" "mw update-relationship <npc_id> <relationship_id> '<json_body>'"
    require_arg "$4" "mw update-relationship <npc_id> <relationship_id> '<json_body>'"
    request PUT "/npcs/$2/relationships/$3" "$4"
    ;;
  delete-relationship)
    require_arg "$2" "mw delete-relationship <npc_id> <relationship_id>"
    require_arg "$3" "mw delete-relationship <npc_id> <relationship_id>"
    request DELETE "/npcs/$2/relationships/$3"
    ;;

  # === Channel Bindings ===
  bind-channel)
    require_arg "$2" "mw bind-channel <npc_id> <platform> <channel_id>"
    require_arg "$3" "mw bind-channel <npc_id> <platform> <channel_id>"
    require_arg "$4" "mw bind-channel <npc_id> <platform> <channel_id>"
    request POST "/channels/bind" "{\"npc_id\":\"$2\",\"platform\":\"$3\",\"platform_channel_id\":\"$4\"}"
    ;;
  unbind-channel)
    require_arg "$2" "mw unbind-channel <platform> <channel_id>"
    require_arg "$3" "mw unbind-channel <platform> <channel_id>"
    request DELETE "/channels/bind" "{\"platform\":\"$2\",\"platform_channel_id\":\"$3\"}"
    ;;
  list-bindings)
    request GET "/channels/bindings"
    ;;
  resolve-channel)
    require_arg "$2" "mw resolve-channel <platform> <channel_id>"
    require_arg "$3" "mw resolve-channel <platform> <channel_id>"
    platform=$(urlencode "$2")
    channel_id=$(urlencode "$3")
    request GET "/channels/resolve?platform=${platform}&platform_channel_id=${channel_id}"
    ;;

  # === Project ===
  stats)
    request GET "/stats"
    ;;
  health)
    request GET "/health" "" "raw"
    ;;

  *)
    printf "${RED}Unknown command: $1. Run 'mw --help' for usage.${RESET}\n" >&2
    exit $EXIT_USAGE
    ;;
esac
